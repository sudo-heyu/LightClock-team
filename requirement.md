# LightClock 智能光唤醒闹钟需求文档 (V1.3)

## 1. 项目概述
*   **项目名称**：LightClock (智能光唤醒闹钟)
*   **核心目标**：通过蓝牙同步时间与闹钟，利用模拟日出的渐变光线唤醒用户。提供极简的交互体验与极低的待机功耗。
*   **设计原则**：极简交互，最大化深度睡眠以延长电池续航。

---

## 2. 硬件架构与引脚分配

### 2.1 核心控制映射
| 功能分类 | 引脚 (IO) | 类型 | 功能描述 | 参数/备注 |
| :--- | :--- | :--- | :--- | :--- |
| **显示驱动** | **IO4** | 开漏 | I2C SDA (CH455G) | 驱动四位数码管 (100kHz) |
| | **IO5** | 开漏 | I2C SCL (CH455G) | |
| **光源控制** | **IO6** | PWM | PWM_WARM (暖光 LED) | LEDC 通道 0, >20kHz |
| | **IO7** | PWM | PWM_COOL (冷光 LED) | LEDC 通道 1, >20kHz |
| **交互输入** | **IO20** | 输入 | BTN (用户按键) | 低电平有效，硬件消抖 |
| **电源管理** | **IO3** | ADC | BAT_ADC (电池采样) | 分压比: 15.1k/5.1k |
| | **IO21** | 推挽 | BAT_ADC_EN | 高电平使能采样，平时关闭 |
| | **IO10** | 输入 | PG (充电状态检测) | 高电平表示 USB 插入 |
| **实时时钟** | **IO0 / 1** | 专用 | 32.768kHz 外部晶振 | 用于 RTC 走时及深度睡眠 |

---

## 3. 蓝牙服务 (GATT) 设计

**主服务 UUID**: `0x0000FF10-0000-1000-8000-00805F9B34FB`

### 3.1 特征值规格
| 特征 UUID | 属性 | 数据格式 | 功能说明 |
| :--- | :--- | :--- | :--- |
| **0xFF11** | 读/写 | `HHMM` (4B String) | **闹钟设定**：写入如 "0730" 代表 07:30 闹钟 |
| **0xFF12** | 写 | `HHMMSS` (6B String) | **系统校时**：同步手机 RTC 当前时间 |
| **0xFF13** | 读/通知 | `Uint8` (0-100) | **电量上报**：当前电池百分比 |
| **0xFF14** | 写 | `Uint8` (0-100) | **色温调节**：0(纯冷) - 100(纯暖) |
| **0xFF15** | 写 | `Uint8` (0-100) | **唤醒亮度**：设定日出最高亮度目标 |
| **0xFF16** | 写 | `Uint8` (5-60) | **模拟时长**：设定日出模拟过程的时长 (单位: 分钟) |

---

## 4. 软件逻辑与状态机

### 4.1 核心行为模式
*   **初始化**：上电读取 NVS 中的 `device_config_t`，计算下一次唤醒时间并进入深度睡眠。
*   **日出唤醒**：在设定的闹钟时间前 `sunrise_duration` 分钟开始。光线从 0% 线性增加到 `0xFF15` 设定的亮度。
*   **台灯模式**：长按按键进入。使用 `0xFF14` 设定的比例点亮 LED，数码管常亮。
*   **时间查看**：短按按键点亮数码管 20 秒，同时开启蓝牙广播供 App 连接。

### 4.2 状态转换
1.  **DEEP_SLEEP**：极低功耗模式，等待 RTC 定时或按键唤醒。
2.  **ACTIVE_IDLE**：短按唤醒后状态，开启蓝牙与数码管（20秒超时）。
3.  **ALARM_GRADIENT**：由 `0xFF16` 设定的时长决定的模拟日出过程。短按可关闭。
4.  **MANUAL_LIGHT**：常亮台灯模式。长按切换回睡眠。

---

## 5. 存储结构 (NVS)
```c
typedef struct {
    uint8_t alarm_hour;        // 闹钟时 (0-23)
    uint8_t alarm_minute;      // 闹钟分 (0-59)
    uint8_t color_temp;        // 台灯色温 (0-100)
    uint8_t wake_bright;       // 唤醒目标最大亮度 (0-100)
    uint8_t sunrise_duration;  // 模拟时长 (5-60)
} device_config_t;
```

---

## 6. ⚠️ 关键注意事项

### 6.1 功耗管理
*   **深度睡眠与蓝牙**：ESP32-C3 进入深度睡眠后蓝牙会断开。配置完成后应在断开连接后进入睡眠（建议在 `ESP_GATTS_DISCONNECT_EVT` 事件中延迟 2 秒执行）。
*   **外设断电**：进入睡眠前必须将 **IO21 (BAT_ADC_EN)** 设为低电平，关闭采样电路以防止分压电阻漏电。
*   **引脚状态**：确保 PWM 输出及 I2C 引脚在睡眠期间处于固定电平，避免悬空导致漏电。

### 6.2 广播与扫描
*   **激活逻辑**：非常开模式下，仅在短按按键激活数码管的 20 秒内开启蓝牙广播。
*   **调试模式**：若 `CONFIG_LIGHT_ALARM_ALWAYS_ON` 为 1，则设备保持常开广播。
*   **广播内容**：包含 Flags(0x06) + 16-bit Service UUID (0xFF10) + 设备名 (LightClock_001)。

### 6.3 硬件驱动要求
*   **PWM 频率**：暖/冷两路 LEDC 频率应 > 20kHz 以消除频闪。
*   **ADC 采样**：采样前需开启 IO21 稳定 10ms，采用多次采样取平均值的方法以提高精度。
*   **调试串口**：由于 GPIO20/21 可能与默认 UART 冲突，建议将控制台重定向至 USB-Serial/JTAG 端口。

---

## 7. 调试配置
*   `CONFIG_LIGHT_ALARM_ALWAYS_ON`: 禁用深度睡眠，蓝牙始终广播。
*   `CONFIG_LIGHT_ALARM_DEBUG_DISABLE_DEEP_SLEEP`: 保持 COM 口连接稳定。
*   **设备名**: `LightClock_001`
