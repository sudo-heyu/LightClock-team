# LightClock 智能光唤醒闹钟需求文档 (V1.4)

## 1. 项目概述
*   **项目名称**：LightClock (智能光唤醒闹钟)
*   **核心目标**：通过蓝牙同步时间与闹钟，利用模拟日出的渐变光线唤醒用户。提供极简的交互体验与极低的待机功耗。
*   **设计原则**：极简交互，最大化深度睡眠以延长电池续航。

---

## 2. 硬件架构与引脚分配

### 2.1 核心控制映射
| 功能分类 | 引脚 (IO) | 类型 | 功能描述 | 参数/备注 |
| :--- | :--- | :--- | :--- | :--- |
| **显示驱动** | **IO4** | 开漏 | I2C SDA (CH455G) | 驱动四位数码管 (100kHz) |
| | **IO5** | 开漏 | I2C SCL (CH455G) | |
| **光源控制** | **IO6** | PWM | PWM_WARM (暖光 LED) | LEDC 通道 0, >20kHz |
| | **IO7** | PWM | PWM_COOL (冷光 LED) | LEDC 通道 1, >20kHz |
| **交互输入** | **IO20** | 输入 | BTN (用户按键) | 低电平有效，硬件消抖 |
| **电源管理** | **IO3** | ADC | BAT_ADC (电池采样) | 分压比: 15.1k/5.1k |
| | **IO21** | 推挽 | BAT_ADC_EN | 默认按高电平使能采样；固件启动时会做极性自检并兼容低电平使能的硬件 |
| | **IO10** | 输入 | PG (充电状态检测) | 高电平表示 USB 插入 |
| **实时时钟** | **IO0 / 1** | 专用 | 32.768kHz 外部晶振 | 用于 RTC 走时及深度睡眠 |

---

## 3. 蓝牙服务 (GATT) 设计

**主服务 UUID**: `0x0000FF10-0000-1000-8000-00805F9B34FB`

### 3.1 特征值规格
| 特征 UUID | 属性 | 数据格式 | 功能说明 |
| :--- | :--- | :--- | :--- |
| **0xFF11** | 读/写 | `HHMME` (5B String) | **闹钟设定**：写入如 "07301" 代表 07:30 开启，"07300" 代表关闭 |
| **0xFF12** | 写 | `HHMMSS` (6B String) | **系统校时**：同步手机 RTC 当前时间 |
| **0xFF13** | 读/通知 | `Uint8` (0-100) | **电量上报**：当前电池百分比 |
| **0xFF14** | 写 | `Uint8` (0-100) | **色温调节**：0(纯冷) - 100(纯暖) |
| **0xFF15** | 写 | `Uint8` (0-100) | **唤醒亮度**：设定日出最高亮度目标 |
| **0xFF16** | 写 | `Uint8` (1-60) | **模拟时长**：设定日出模拟过程的时长 (单位: 分钟) |

---

## 4. 软件逻辑与状态机

### 4.1 核心行为模式
*   **绑定模式**：App 自动记忆上次连接成功的 `LightClock_` 开头设备。
*   **自动连接**：App 启动时若发现已绑定设备在附近，则自动发起连接。
*   **日出唤醒**：在设定的闹钟时间前 `sunrise_duration` 分钟开始。光线从 0% 线性增加到 `0xFF15` 设定的亮度。
*   **台灯模式**：长按按键切换（进入/退出）。进入后亮度直接到 `0xFF15`（最大亮度设定），色温按 `0xFF14`；保持点亮直到再次长按退出。
*   **短按显示时间**：短按仅用于点亮数码管显示当前时间，显示窗口固定为 10 秒；在台灯模式期间短按只影响显示，不影响台灯点亮状态。

---

## 5. ⚠️ 技术注意事项 (规范化)

### 5.1 功耗与电源管理
*   **深度睡眠策略**：
	*   **V1.4 原始设计**：完成配置且蓝牙断开后进入深度睡眠以节省能源。
	*   **当前实现（按最新需求）**：取消深度睡眠，未连接时持续广播，断开连接后立即恢复广播，保持设备长期可发现。
*   **IO 状态控制**：若进入睡眠/低功耗模式，**IO21 (BAT_ADC_EN)** 必须置为“禁用采样”的电平（注意硬件可能为高/低有效；当前固件会自动探测极性并在空闲时保持禁用）。同时确保 I2C 和 PWM 引脚电平固定，严禁悬空。
*   **ADC 精准度**：采样前需开启 IO21 并预留 10ms 稳定期，采用多点采样取平均值策略；ADC 衰减按硬件输入范围配置（当前固件使用 6dB）。
*   **ADC 换算公式**（12 位 SAR ADC）：
	*   $V_{data}=V_{ref} \times data / 4095$，其中 $V_{ref}\approx 1100mV$（出厂设定）。
	*   若需要测量大于 $V_{ref}$ 的电压，需配置输入衰减；当前固件使用 6dB 衰减。固件优先使用 ESP-IDF 校准换算；当校准不可用时，fallback 会按上述公式并结合 6dB（近似 ×2）进行估算。
	*   **调试开关**：可通过 `CONFIG_LIGHT_ALARM_DEBUG_BAT_ADC_EN_ALWAYS_HIGH` 让 **BAT_ADC_EN** 常态保持高电平，便于示波器/万用表调试；关闭该开关时，固件仅在采样窗口拉高 BAT_ADC_EN。

### 5.2 蓝牙与连接规范
*   **广播触发**：
	*   **V1.4 原始设计**：设备非持续广播模式。
	*   **当前实现（按最新需求）**：设备持续广播（未连接时），断开后立即恢复广播。
*   **自动重连**：App 端需实现基于 MAC 地址的静默扫描与自动重连逻辑，提升用户“无感”体验。
*   **解除绑定**：提供故障重置功能，清除手机端存储的 MAC 地址并断开当前链路。

### 5.3 硬件驱动要求
*   **频闪消除**：LEDC (PWM) 频率必须维持在 20kHz 以上。
*   **串口冲突**：GPIO20/21 与默认调试串口存在潜在冲突，量产固件建议将控制台重定向至内置 USB-JTAG。
